<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fintech & KPI Control Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; }
        .gradient-sidebar { background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%); }
        .kpi-table th { font-size: 9px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; padding-bottom: 8px; }
        .kpi-table td { font-size: 11px; padding: 6px 0; border-bottom: 1px solid #f1f5f9; }
        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="text-slate-900 overflow-x-hidden">

    <div class="flex flex-col xl:flex-row min-h-screen">
        
        <div class="w-full xl:w-[400px] gradient-sidebar text-white p-8 shrink-0 shadow-2xl z-10">
            <div class="sticky top-8">
                <div class="mb-10">
                    <p class="text-blue-400 font-bold text-[10px] uppercase tracking-[0.3em] mb-1">Korxona Nazorati</p>
                    <h1 class="text-3xl font-800 tracking-tighter">DASHBOARD<span class="text-blue-500">.</span></h1>
                </div>

                <div class="space-y-4 mb-10">
                    <div class="bg-blue-600 p-7 rounded-[2.5rem] shadow-xl">
                        <p class="text-[10px] font-black text-blue-200 uppercase tracking-widest mb-1">Umumiy Debitorlik</p>
                        <h2 id="globalTotal" class="text-3xl font-800 leading-none">0</h2>
                        <span id="globalClients" class="text-xs font-bold text-blue-100 mt-3 block opacity-70 italic">Yuklanmoqda...</span>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white/5 p-5 rounded-3xl border border-white/10">
                            <p class="text-[9px] font-black text-red-400 uppercase tracking-widest mb-1">Muddati o'tgan</p>
                            <h2 id="globalExpired" class="text-lg font-800 text-white">0</h2>
                        </div>
                        <div id="trendBox" class="bg-white/5 p-5 rounded-3xl border border-white/10 hidden">
                            </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <button onclick="init()" class="w-full py-5 bg-white text-slate-900 rounded-2xl font-800 hover:bg-blue-50 transition-all shadow-lg active:scale-95">
                        ðŸ”„ MA'LUMOTLARNI YANGILASH
                    </button>
                    <a href="index.html" class="block text-center w-full py-4 text-slate-400 hover:text-white transition-all font-bold text-sm">
                        Tizimdan chiqish
                    </a>
                </div>
            </div>
        </div>

        <div class="flex-1 p-6 lg:p-12">
            <header class="mb-10 flex justify-between items-end">
                <div>
                    <h2 class="text-3xl font-800 text-slate-800 tracking-tight">Agentlar Faoliyati</h2>
                    <p class="text-slate-400 font-bold text-sm">Debitorlik va KPI ko'rsatkichlari integratsiyasi</p>
                </div>
                <div class="text-right hidden md:block">
                    <p class="text-[10px] font-black text-slate-400 uppercase">Oxirgi yangilanish</p>
                    <p id="lastUpdate" class="font-bold text-slate-600">-:-</p>
                </div>
            </header>

            <div id="agentsArea" class="grid grid-cols-1 md:grid-cols-2 2xl:grid-cols-2 gap-8">
                </div>
        </div>
    </div>

    <script>
        // SOZLAMALAR
        const API_FIREBASE = "https://debetorka-c758e-default-rtdb.europe-west1.firebasedatabase.app";
        const API_RITM = "https://afsona.ritm.uz/ru/api/v1/staff/salary/?year=2026&month=2&page_size=25&is_approved=all";
        const RITM_TOKEN = "bf393005b50920a5f8906c818591ec8964da00d6";

        // Agentlarni Ritm.uz IDlari bilan bog'lash
        const AGENT_MAPPING = {
            "Ð¨ÑƒÑ…Ñ€Ð°Ñ‚": 556,
            "Ð¨ÑƒÑ…Ñ€Ð°Ñ‚": 556,
            "Ð‘Ð¾Ð±ÑƒÑ€": 558, // O'zingizdagi IDlarni shu yerga qo'shing
            // Boshqa agentlar...
        };

        async function init() {
            const area = document.getElementById('agentsArea');
            area.innerHTML = `<div class="col-span-full py-20 text-center font-bold text-slate-400 animate-pulse">Ma'lumotlar tahlil qilinmoqda...</div>`;
            
            try {
                const res = await fetch(`${API_FIREBASE}/reports.json`);
                const allData = await res.json();
                
                const histRes = await fetch(`${API_FIREBASE}/history.json`);
                const historyData = await histRes.json();

                if (allData) processAdminData(allData, historyData);
                document.getElementById('lastUpdate').innerText = new Date().toLocaleTimeString('uz-UZ');
            } catch (e) {
                console.error(e);
                area.innerHTML = `<div class="text-red-500">Xatolik yuz berdi: ${e.message}</div>`;
            }
        }

        async function fetchKPI(agentId) {
    const token = "bf393005b50920a5f8906c818591ec8964da00d6";
    
    // Hozirgi sana (2026-yil, 2-oy)
    const year = 2026; 
    const month = 2;

    const url = `https://afsona.ritm.uz/ru/api/v1/staff/salary/${agentId}/?year=${year}&month=${month}`;

    try {
        const response = await fetch(url, {
            headers: { "Authorization": `Token ${token}` }
        });
        const data = await response.json();
        
        // DIAGNOSTIKA: Konsolda ma'lumot bor-yo'qligini ko'ramiz
        console.log(`Agent ID: ${agentId} uchun ma'lumot:`, data.balances);

        if (!data.balances || data.balances.length === 0) {
            console.warn(`Diqqat: ${agentId} uchun ${year}-yil ${month}-oyda KPI ma'lumotlari bo'sh!`);
            return null;
        }
        return data.balances;
    } catch (e) {
        console.error("Fetch xatosi:", e);
        return null;
    }
}

        async function processAdminData(allData, historyData) {
            let global = { tt: 0, ex: 0, clients: 0 };
            let agentList = [];
            const now = new Date(); now.setHours(0,0,0,0);

            for (let name in allData) {
                let aStats = { name: name, tt: 0, ex: 0, clients: 0 };
                if (allData[name].zones) {
                    allData[name].zones.forEach(z => {
                        if (z.debtors) {
                            z.debtors.forEach(d => {
                                aStats.tt += d.a; global.tt += d.a;
                                aStats.clients++; global.clients++;
                                if (d.d !== "No Date" && new Date(d.d) < now) {
                                    aStats.ex += d.a; global.ex += d.a;
                                }
                            });
                        }
                    });
                }
                agentList.push(aStats);
            }

            // UI Global
            document.getElementById('globalTotal').innerText = global.tt.toLocaleString();
            document.getElementById('globalExpired').innerText = global.ex.toLocaleString();
            document.getElementById('globalClients').innerText = global.clients + " ta faol mijoz";

            if (historyData) calculateTrend(global.tt, historyData);
            
            agentList.sort((a, b) => b.tt - a.tt);
            renderAgents(agentList);
        }

        function calculateTrend(current, history) {
            let prev = 0;
            for (let a in history) {
                const entries = Object.values(history[a]);
                if (entries.length > 1) prev += entries[entries.length - 2].t;
            }
            if (prev > 0) {
                const diff = current - prev;
                const perc = ((Math.abs(diff) / prev) * 100).toFixed(1);
                const isDown = diff < 0;
                const tBox = document.getElementById('trendBox');
                tBox.classList.remove('hidden');
                tBox.innerHTML = `
                    <p class="text-[9px] font-black ${isDown ? 'text-emerald-400' : 'text-red-400'} uppercase">Dinamika</p>
                    <h2 class="text-lg font-800">${isDown ? 'â†“' : 'â†‘'} ${perc}%</h2>
                `;
            }
        }

        async function renderAgents(agentList) {
            const area = document.getElementById('agentsArea');
            area.innerHTML = '';

            for (const a of agentList) {
                const quality = a.tt > 0 ? (100 - (a.ex / a.tt * 100)).toFixed(1) : 100;
                const ritmId = AGENT_MAPPING[a.name];
                let kpiHtml = `<div class="mt-4 p-4 bg-slate-50 rounded-2xl text-[10px] text-slate-400 italic">Ritm.uz ma'lumotlari topilmadi</div>`;

                if (ritmId) {
                    const balances = await fetchKPI(ritmId);
                    if (balances) {
                        kpiHtml = `
                        <div class="mt-6">
                            <div class="flex items-center justify-between mb-3">
                                <p class="text-[10px] font-black text-blue-600 uppercase tracking-widest">KPI Tendensiya</p>
                                <span class="text-[9px] text-slate-400 font-bold">Fevral 2026</span>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full kpi-table">
                                    <thead>
                                        <tr>
                                            <th class="text-left">KPI Nomi</th>
                                            <th class="text-right">Plan</th>
                                            <th class="text-right">Fakt</th>
                                            <th class="text-right">%</th>
                                            <th class="text-right">Prognoz</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${balances.map(b => {
                                            const p = b.plan_amount > 0 ? (b.fact_amount / b.plan_amount * 100).toFixed(1) : 0;
                                            const fP = b.plan_amount > 0 ? (b.plan_forecast / b.plan_amount * 100).toFixed(1) : 0;
                                            return `
                                                <tr>
                                                    <td class="font-bold text-slate-600 truncate max-w-[100px]">${b.performance_indicator.name}</td>
                                                    <td class="text-right text-slate-400">${Math.round(b.plan_amount).toLocaleString()}</td>
                                                    <td class="text-right font-black text-slate-800">${Math.round(b.fact_amount).toLocaleString()}</td>
                                                    <td class="text-right font-black ${p >= 50 ? 'text-emerald-500' : 'text-amber-500'}">${p}%</td>
                                                    <td class="text-right font-bold text-blue-500">${fP}%</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>`;
                    }
                }

                area.innerHTML += `
                    <div class="bg-white p-8 rounded-[3rem] shadow-sm border border-slate-100 hover:shadow-2xl transition-all duration-500 group">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h3 class="text-2xl font-800 text-slate-800 group-hover:text-blue-600 transition-colors">${a.name}</h3>
                                <p class="text-xs font-bold text-slate-400 mt-1">${a.clients} ta qarzdor mijoz</p>
                            </div>
                            <div class="text-right">
                                <div class="px-4 py-2 bg-slate-50 rounded-2xl border border-slate-100">
                                    <p class="text-[8px] font-black text-slate-400 uppercase">Ish sifati</p>
                                    <p class="text-lg font-900 ${quality > 80 ? 'text-emerald-500' : 'text-amber-500'}">${quality}%</p>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-slate-50 p-4 rounded-2xl">
                                <p class="text-[9px] font-black text-slate-400 uppercase">Jami Qarz</p>
                                <p class="text-md font-800">${a.tt.toLocaleString()}</p>
                            </div>
                            <div class="bg-red-50 p-4 rounded-2xl">
                                <p class="text-[9px] font-black text-red-400 uppercase">Kechikkan</p>
                                <p class="text-md font-800 text-red-600">${a.ex.toLocaleString()}</p>
                            </div>
                        </div>

                        ${kpiHtml}
                        
                        <button onclick="window.location.href='dashboard.html?agent=${encodeURIComponent(a.name)}'" 
                                class="w-full mt-6 py-3 bg-slate-100 text-slate-600 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-blue-600 hover:text-white transition-all">
                            Batafsil tahlil â†’
                        </button>
                    </div>
                `;
            }
        }

        init();
    </script>
</body>
</html>